datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../src/lib/server/db/generated/prisma"
}

/* =========================================================
   1. USER & SYSTEM ACCESS
   ========================================================= */

model User {
  id              String   @id @default(cuid())

  // Personal Details (Bilingual)
  nameEn          String
  nameAr          String
  phoneNumber     String   @unique
  passwordHash    String
  userAuthToken   String   @unique
  
  specialization  String  // e.g., "Orthodontist", "General Practitioner"

  // SYSTEM ROLE: Defines if this is You (SaaS Admin) or a Client (Doctor)
  systemRole      SystemRole @default(CUSTOMER)

  // MEMBERSHIPS: Where does this user work?
  clinicMemberships    ClinicMember[]
  centerMemberships    MedicalCenterMember[]

  // PATIENT ACCESS:
  // 1. Audit: Who originally created the patient profile?
  createdPatients      Patient[]       @relation("PatientCreator")
  // 2. Visiting Access: Specific patients a Visiting Doctor is allowed to see
  accessiblePatients   PatientAccess[]
  
  // OPERATIONS:
  appointments         Appointment[]   @relation("DoctorAppointments")
  // REMOVED: MedicalRecords relation

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  status          UserStatus @default(ACTIVE)
}

/* =========================================================
   2. FACILITIES (Tenants)
   ========================================================= */

model Clinic {
  id            String   @id @default(cuid())
  name          String   @unique

  // SUBSCRIPTION & STATUS
  status             SubscriptionStatus @default(PENDING) // Needs Admin Approval
  subscriptionEndsAt DateTime?          // For SaaS billing logic

  // Staff & Management
  members       ClinicMember[]

  // Patient Registry
  patients      Patient[] @relation("PatientClinics")

  // Financials & Operations
  prices        FacilityPrice[]
  appointments  Appointment[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model MedicalCenter {
  id             String  @id @default(cuid())
  centerName     String

  // SUBSCRIPTION & STATUS
  status             SubscriptionStatus @default(PENDING) // Needs Admin Approval
  subscriptionEndsAt DateTime?          // For SaaS billing logic

  // Staff & Management
  members        MedicalCenterMember[]

  // Patient Registry
  patients       Patient[] @relation("PatientMedicalCenters")

  // Financials & Operations
  prices         FacilityPrice[]
  appointments   Appointment[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

/* =========================================================
   3. MEMBERSHIPS (Role-Based Access Control)
   ========================================================= */

model ClinicMember {
  id        String      @id @default(cuid())
  
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  clinicId  String
  clinic    Clinic      @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  role      ClinicRole  
  
  joinedAt  DateTime    @default(now())

  @@unique([userId, clinicId]) 
}

model MedicalCenterMember {
  id              String   @id @default(cuid())
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  medicalCenterId String
  medicalCenter   MedicalCenter @relation(fields: [medicalCenterId], references: [id], onDelete: Cascade)

  role            CenterRole 

  joinedAt        DateTime      @default(now())

  @@unique([userId, medicalCenterId])
}

/* =========================================================
   4. PATIENTS & PRIVACY
   ========================================================= */

model Patient {
  id            String   @id @default(cuid())

  fullnameEn    String
  fullnameAr    String   
  phoneNumber   String   @unique
  birthDate     DateTime?
  gender        Gender?

  // Facility Links (Where have they been treated?)
  clinics        Clinic[]        @relation("PatientClinics")
  medicalCenters MedicalCenter[] @relation("PatientMedicalCenters")

  // Audit: Who typed them in first?
  createdById   String
  createdBy     User     @relation("PatientCreator", fields: [createdById], references: [id])

  // Security: Grants access to Visiting Doctors
  doctorAccess  PatientAccess[]

  // Medical Data
  appointments  Appointment[]
  // REMOVED: MedicalRecords relation

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([phoneNumber])
}

// The "Key" that opens a patient file for a Visiting Doctor
model PatientAccess {
  id          String   @id @default(cuid())

  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId    String
  doctor      User     @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  // Context: Access is granted usually when an appointment is made
  clinicId    String? 
  
  grantedAt   DateTime @default(now())

  @@unique([patientId, doctorId, clinicId])
}

/* =========================================================
   5. OPERATIONS (Appointments)
   ========================================================= */

model Appointment {
  id          String   @id @default(cuid())
  
  date        DateTime // Date and Time of visit
  
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
  
  doctorId    String
  doctor      User     @relation("DoctorAppointments", fields: [doctorId], references: [id])

  // Link to EITHER a Clinic OR a Center
  clinicId        String?
  clinic          Clinic?        @relation(fields: [clinicId], references: [id])
  
  medicalCenterId String?
  medicalCenter   MedicalCenter? @relation(fields: [medicalCenterId], references: [id])

  status      AppointmentStatus @default(SCHEDULED)
  notes       String?

  createdAt   DateTime @default(now())
}

// REMOVED: MedicalRecord Model

/* =========================================================
   6. TREATMENTS & PRICING CATALOG
   ========================================================= */

model TreatmentGroup {
  id          String   @id @default(cuid())
  nameEn      String   @unique 
  nameAr      String?
  color       String   // UI decoration
  treatments  Treatment[]
}

model Treatment {
  id          String   @id @default(cuid())
  nameEn      String   
  nameAr      String?  
  
  groupId     String
  group       TreatmentGroup @relation(fields: [groupId], references: [id])

  basePrice   Decimal? @default(0.0)
  
  // Custom prices per facility
  facilityPrices FacilityPrice[]
  
  // REMOVED: records relation
}

model FacilityPrice {
  id              String    @id @default(cuid())
  price           Decimal
  
  treatmentId     String
  treatment       Treatment @relation(fields: [treatmentId], references: [id])
  
  clinicId        String?
  clinic          Clinic?   @relation(fields: [clinicId], references: [id])
  
  medicalCenterId String?
  medicalCenter   MedicalCenter? @relation(fields: [medicalCenterId], references: [id])

  @@unique([treatmentId, clinicId])
  @@unique([treatmentId, medicalCenterId])
}

/* =========================================================
   7. ENUMS (Logic Control)
   ========================================================= */

enum SystemRole {
  CUSTOMER       // Doctors, Owners, Nurses
  SUPPORT_AGENT  // Your Company Staff (Read Only / Debug)
  SUPER_ADMIN    // Your Company Owner (Full Control)
}

enum ClinicRole {
  OWNER            // Can delete clinic, set prices, see all patients
  DOCTOR_EMPLOYEE  // See all patients, add records
  VISITING_DOCTOR  // RESTRICTED: See only assigned 'PatientAccess' patients
  ASSISTANT        // Schedule only
}

enum CenterRole {
  OWNER            // Business Owner
  DOCTOR           // Medical Staff (Full Access to Center Patients)
  NURSE            // Support
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum SubscriptionStatus {
  PENDING   // Signed up, waiting for payment/approval
  ACTIVE    // Paid and running
  SUSPENDED // Payment failed or policy violation
  CANCELLED // User stopped service
}

enum Gender {
  MALE
  FEMALE
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}