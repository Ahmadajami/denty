datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../src/lib/server/db/generated/prisma"
}
/* =========================================================
   1. USER & SYSTEM ACCESS
   ========================================================= */

model User {
  id              String   @id @default(cuid())

  // Personal Details
  nameEn          String
  nameAr          String
  phoneNumber     String   @unique
  passwordHash    String
  userAuthToken   String   @unique // Session token
  
  specialization  String?  // Nullable because Admins/Owners might not be doctors

  // Role Management
  systemRole      SystemRole @default(CUSTOMER)
  status          UserStatus @default(ACTIVE)

  // MEMBERSHIPS (Where they work)
  clinicMemberships    ClinicMember[]
  centerMemberships    MedicalCenterMember[]

  // ACCESS & AUDIT
  createdPatients      Patient[]       @relation("PatientCreator")
  accessiblePatients   PatientAccess[] // For Visiting Doctors

  // OPERATIONS (Doctor Specific)
  appointments         Appointment[]      @relation("DoctorAppointments")
  performedTreatments  TreatmentSession[] @relation("PerformedTreatments")

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Performance Indexes
  @@index([systemRole])
  @@index([status])
}

/* =========================================================
   2. FACILITIES (Tenants)
   ========================================================= */

model Clinic {
  id                 String   @id @default(cuid())
  name               String   @unique

  // Subscription Logic
  status             SubscriptionStatus @default(PENDING)
  subscriptionEndsAt DateTime?          

  // Relations
  members            ClinicMember[]
  patients           Patient[]          @relation("PatientClinics")
  facilityPrices     FacilityPrice[]
  appointments       Appointment[]
  treatmentSessions  TreatmentSession[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Indexes for Cron Jobs & Admin Dashboard
  @@index([status])
  @@index([subscriptionEndsAt])
}

model MedicalCenter {
  id                 String  @id @default(cuid())
  centerName         String

  // Subscription Logic
  status             SubscriptionStatus @default(PENDING)
  subscriptionEndsAt DateTime?          

  // Relations
  members            MedicalCenterMember[]
  patients           Patient[]           @relation("PatientMedicalCenters")
  facilityPrices     FacilityPrice[]
  appointments       Appointment[]
  treatmentSessions  TreatmentSession[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Indexes for Cron Jobs & Admin Dashboard
  @@index([status])
  @@index([subscriptionEndsAt])
}

/* =========================================================
   3. MEMBERSHIPS (RBAC)
   ========================================================= */

model ClinicMember {
  id        String      @id @default(cuid())
  
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  clinicId  String
  clinic    Clinic      @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  role      ClinicRole  
  
  joinedAt  DateTime    @default(now())

  @@unique([userId, clinicId]) 
  @@index([userId])  // Speed up "GetUserMemberships"
  @@index([clinicId]) // Speed up "GetClinicStaff"
}

model MedicalCenterMember {
  id              String   @id @default(cuid())
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  medicalCenterId String
  medicalCenter   MedicalCenter @relation(fields: [medicalCenterId], references: [id], onDelete: Cascade)

  role            CenterRole 

  joinedAt        DateTime      @default(now())

  @@unique([userId, medicalCenterId])
  @@index([userId])
  @@index([medicalCenterId])
}

/* =========================================================
   4. PATIENTS
   ========================================================= */

model Patient {
  id            String   @id @default(cuid())

  fullnameEn    String
  fullnameAr    String   
  phoneNumber   String   @unique
  birthDate     DateTime?
  gender        Gender?

  // Facility Links
  clinics        Clinic[]        @relation("PatientClinics")
  medicalCenters MedicalCenter[] @relation("PatientMedicalCenters")

  // Audit
  createdById   String
  createdBy     User     @relation("PatientCreator", fields: [createdById], references: [id])

  // Security
  doctorAccess  PatientAccess[]

  // Operations
  appointments      Appointment[]
  treatmentSessions TreatmentSession[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Search Optimization
  @@index([fullnameEn]) // Fast text search
  @@index([fullnameAr]) // Fast text search
  @@index([phoneNumber])
}

model PatientAccess {
  id          String   @id @default(cuid())

  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId    String
  doctor      User     @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  clinicId    String? 
  
  grantedAt   DateTime @default(now())

  @@unique([patientId, doctorId, clinicId])
  @@index([doctorId]) // Fast lookup for "My Visiting Patients"
}

/* =========================================================
   5. OPERATIONS (Appointments & Sessions)
   ========================================================= */

model Appointment {
  id          String   @id @default(cuid())
  
  date        DateTime 
  status      AppointmentStatus @default(SCHEDULED)
  notes       String?
  
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  doctorId    String
  doctor      User     @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: Cascade)

  clinicId        String?
  clinic          Clinic?        @relation(fields: [clinicId], references: [id])
  
  medicalCenterId String?
  medicalCenter   MedicalCenter? @relation(fields: [medicalCenterId], references: [id])

  createdAt   DateTime @default(now())

  @@index([date])      // Calendar queries
  @@index([patientId]) // Patient history
  @@index([doctorId])  // Doctor schedule
  @@index([status])    // Filtering
}

model TreatmentSession {
  id          String   @id @default(cuid())

  // 1. Who?
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId    String
  doctor      User     @relation("PerformedTreatments", fields: [doctorId], references: [id])

  // 2. What? (Many-to-Many implicit relation)
  treatments  Treatment[] 
  
  // 3. Where? (Teeth)
  toothNumbers Int[]   // e.g. [18, 19]

  // 4. Financials
  price       Decimal  @db.Decimal(10, 2) // Precision for currency
  note        String?

  // 5. Context
  clinicId        String?
  clinic          Clinic?        @relation(fields: [clinicId], references: [id])
  
  medicalCenterId String?
  medicalCenter   MedicalCenter? @relation(fields: [medicalCenterId], references: [id])

  createdAt   DateTime @default(now())

  @@index([patientId]) // Patient File
  @@index([doctorId])  // Doctor Revenue
  @@index([createdAt]) // Timeline sorting
}

/* =========================================================
   6. CATALOG
   ========================================================= */

model TreatmentGroup {
  id          String   @id @default(cuid())
  nameEn      String   @unique 
  nameAr      String?
  color       String   
  treatments  Treatment[]
}

model Treatment {
  id          String   @id @default(cuid())
  nameEn      String   
  nameAr      String?  
  
  groupId     String
  group       TreatmentGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Optional fixed prices per facility
  facilityPrices FacilityPrice[]

  // History linkage
  sessions       TreatmentSession[]
  
  @@index([groupId])
}

model FacilityPrice {
  id              String    @id @default(cuid())
  price           Decimal   @db.Decimal(10, 2)
  
  treatmentId     String
  treatment       Treatment @relation(fields: [treatmentId], references: [id], onDelete: Cascade)
  
  clinicId        String?
  clinic          Clinic?   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  
  medicalCenterId String?
  medicalCenter   MedicalCenter? @relation(fields: [medicalCenterId], references: [id], onDelete: Cascade)

  @@unique([treatmentId, clinicId])
  @@unique([treatmentId, medicalCenterId])
}

/* =========================================================
   7. ENUMS
   ========================================================= */

enum SystemRole {
  CUSTOMER
  SUPPORT_AGENT
  SUPER_ADMIN
}

enum ClinicRole {
  OWNER
  DOCTOR_EMPLOYEE
  VISITING_DOCTOR
  ASSISTANT
}

enum CenterRole {
  OWNER
  DOCTOR
  NURSE
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum Gender {
  MALE
  FEMALE
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}